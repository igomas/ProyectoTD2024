---
title: "ProyectoTD2024 Grupo F"
author: "Maria Castellanos, Pablo Pons, Irene Gómez, Jenny Carolina Matamoros, Andreu Herrero"
date: "2024-03-26"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Introduccion

El conjunto de datos que vamos a utilizar para el análisis de nuestro proyecto pertenecen al supermercado Mercadona. En concreto, son tickets de los usuarios que realizan sus compras en dicho supermercado, que tiene como propósito informar de las compras de dichos usuarios. 

En nuestro caso, hemos decidido hacer la exploración de las horas más concurridas, de la evolución del precio de los productos, del método de pago, del precio medio de la compra y de la media de la cantidad de los productos comprados.


# Preguntas

1. A qué hora se suele ir más a comprar?
2. Cuál ha sido la evolución del precio de la leche?
3. Cuánta gente paga con tarjeta?
4. Cual es el precio medio de los tickets?
5. Media de la cantidad de "x producto" en los ultimos meses

```{r}
# Hacemos la importación de los datos
library(readr)

# Primero vamos a guardar en una variable la ruta donde se encuentra la carpeta con todos nuestros ficheros
carpeta_ruta <- ".\\data"

# Obtenemos la lista de archivos de texto en la carpeta
archivos_texto <- list.files(path = carpeta_ruta, pattern = "\\.txt$", full.names = TRUE)

# Creamos una lista donde almacenaremos los dataframes que iremos creando de cada archivo
lista_dataframe <- list()

# Iteramos sobre cada archivo en la lista de archivos
for (archivo in archivos_texto) {
  # Intentamos leer las líneas del archivo
  tryCatch({
    lineas <- read_lines(archivo)
    
    # Eliminamos líneas en blanco o vacías
    lineas <- lineas[lineas != ""]
    
    # Extraemos la información relevante
    empresa <- lineas[1]
    direccion <- lineas[2]
    ciudad <- lineas[3]
    telefono <- lineas[4]
    fecha <- lineas[5]
    numero_operacion <- lineas[6]
    factura <- lineas[7]
    
    # Buscamos la posición donde comienzan los productos
    inicio_productos <- grep("Descripción P. Unit Importe", lineas)
    
    # Si encontramos la posición, procesamos los productos
    if (length(inicio_productos) > 0) {
      productos <- lineas[(inicio_productos + 2):(length(lineas) - 1)]
      
      # Separamos los productos en cantidad, producto y precio
      productos_separados <- str_split(productos, "\\s{2,}")
      
      # Creamos un dataframe para los productos
      df_productos <- data.frame(matrix(unlist(productos_separados), ncol = 3, byrow = TRUE))
      
      # Colocamos los nombres de las columnas
      colnames(df_productos) <- c("Cantidad", "Producto", "Precio")
    } else {
      # Si no hay productos, creamos un dataframe vacío
      df_productos <- data.frame(Cantidad = NA, Producto = NA, Precio = NA)
    }
    
    # Agregamos la información a un dataframe principal
    df_final <- data.frame(Empresa = empresa,
                           Direccion = direccion,
                           Ciudad = ciudad,
                           Telefono = telefono,
                           Fecha = fecha,
                           Numero_Operacion = numero_operacion,
                           Factura = factura,
                           df_productos)
    
    # Agregamos el dataframe a la lista
    lista_dataframe[[length(lista_dataframe) + 1]] <- df_final
  }, error = function(e) {
    cat("Error al procesar el archivo", archivo, ":", conditionMessage(e), "\n")
  })
}

# Combinamos todos los dataframes en uno solo
df_completo <- do.call(rbind, lista_dataframe)
```

