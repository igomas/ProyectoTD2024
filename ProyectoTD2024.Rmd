---
title: "ProyectoTD2024 Grupo F"
author: "Maria Castellanos, Pablo Pons, Irene Gómez, Jenny Carolina Matamoros, Andreu Herrero"
date: "2024-03-26"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Introduccion

El conjunto de datos que vamos a utilizar para el análisis de nuestro proyecto pertenecen al supermercado Mercadona. En concreto, son tickets de los usuarios que realizan sus compras en dicho supermercado, que tiene como propósito informar de las compras de dichos usuarios. 

En nuestro caso, hemos decidido hacer la exploración de las horas más concurridas, de la evolución del precio de los productos, del método de pago, del precio medio de la compra y de la media de la cantidad de los productos comprados.


# Preguntas

1. A qué hora se suele ir más a comprar?
2. Cuál ha sido la evolución del precio de la leche?
3. Cuánta gente paga con tarjeta?
4. Cual es el precio medio de los tickets?
5. Media de la cantidad de "x producto" en los ultimos meses

```{r}
#Hacemos la importacion de los datos
#descargaremos las librerias que necesitamos
library(readr)
#Primero vamos a guardar en una variable la ruta donde se encuentra la carpeta con todos nuestros ficheros
carpeta_ruta <- ".\\data"

#Ahora declararemos una variable donde usaremos el codigo list.files para obtener una lista de archivos dentro de la carpeta.
archivos_texto <- list.files(path = carpeta_ruta , pattern = "\\.txt$", full.names = TRUE)

#crear una lista vacia donde iremos almacvenando los dataframe que iremos creando de cada archivo
lista_dataframe <- list()

# Crearemos un bucle el cual iterará sobre cada archivo en la lista creada previamente
for (archivo in archivos_texto) {
  # Leer las líneas del archivo
  #lineas <- read_lines(archivo)
  lineas <- read_lines(archivo, locale = locale(encoding = "latin1"))

  
  # Eliminar líneas en blanco o vacías
  lineas <- lineas[lineas != ""]
  
  # Extraer la información relevante
  # Extraer la información relevante
  empresa <- lineas[1]
  direccion <- lineas[2]
  ciudad <- lineas[3]
  telefono_linea <- lineas[grep("TELÉFONO:", lineas)]
  telefono <- substring(telefono_linea, regexpr(":", telefono_linea) + 1)
  fecha <- lineas[5]
  numero_operacion <- lineas[6]
  factura <- lineas[7]

  
  # Verificar si la cadena "TOTAL (?)" está presente en las líneas del archivo
  if ("TOTAL (?)" %in% lineas) {
    # Las líneas de productos comienzan desde la línea 9 hasta antes de "TOTAL (?)" 
    productos <- lineas[8:(which(lineas == "TOTAL (?)") - 1)]
    
    # Crear un DataFrame para los productos
    df_product <- data.frame(do.call(rbind, strsplit(productos, " ", fixed = TRUE)))
    
    # Renombrar las columnas del DataFrame de productos
    colnames(df_product) <- c("Cantidad", "Producto")
  } else {
    # Si "TOTAL (?)" no está presente, asignar NA a productos
    df_product <- data.frame(Cantidad = NA, Producto = NA)
  }
   # Agregar el DataFrame de productos al DataFrame principal
  df_final <- data.frame(Empresa = empresa,
                         Direccion = direccion,
                         Ciudad = ciudad,
                         Telefono = telefono,
                         Fecha = fecha,
                         Numero_Operacion = numero_operacion,
                         Factura = factura,
                         df_product)
  
  # Agregar el DataFrame a la lista
  lista_dataframe[[length(lista_dataframe) + 1]] <- df_final
}

# Combinar todos los DataFrames en uno solo
df_completo <- do.call(rbind, lista_dataframe)


```

