---
title: "ProyectoTD2024 Grupo F"
author: "Maria Castellanos, Pablo Pons, Irene Gómez, Jenny Carolina Matamoros, Andreu Herrero, Álvaro Cruz"
date: "2024-03-26"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Introduccion

El conjunto de datos que vamos a utilizar para el análisis de nuestro proyecto pertenecen al supermercado Mercadona. En concreto, son tickets de los usuarios que realizan sus compras en dicho supermercado, que tiene como propósito informar de las compras de dichos usuarios. 

En nuestro caso, hemos decidido hacer la exploración de las horas más concurridas, de la evolución del precio de los productos, del método de pago, del precio medio de la compra y de la media de la cantidad de los productos comprados.


# Preguntas

1. A qué hora se suele ir más a comprar?
2. Cuál ha sido el producto más comprado?
3. En que Mercadona se realizan más ventas?
4. Cual es el precio medio de los tickets?
5. En que mes se ha comprado más "x producto"?

```{r}
#Haremos la importacion de los datos
#descargaremos las librerias que necesitamos
library(readr)
library(dplyr)
library(tidyr)

#Primero vamos a guardar en una variable la ruta donde se encuentra la carpeta con todos los ficheros que utilizaremos
carpeta_ruta <- ".\\data"

#Ahora declararemos una variable donde usaremos el codigo list.files para obtener una lista de archivos dentro de la carpeta de la cual solo vamos a seleccionar los archivos que sean .txt
archivos_texto <- list.files(path = carpeta_ruta , pattern = "\\.txt$", full.names = TRUE)

# Crearemos una lista donde almacenaremos los datos de cada archivo
datos <- list()

#iniciaremos un bucle, el cual iterara con todos los archivos en la lista de archivos
for (archivo in archivos_texto) {
  # Leeremos las líneas del archivo
  lineas <- read_lines(archivo, locale = locale(encoding = "latin1")) #ponemos el encoding correspondiente
  
  #Los datos que nos interesan del ticket son los que se encuentran hasta la linea donde nos   indica el precio total de la compra realizada, por lo que pondremos que busque la palabra    TOTAl, en la cual nos devolvera el numero donde se encuentra en cada archivo
  pos_total <- grep("TOTAL", lineas)
  
  # Si no se encuentra la palabra "TOTAL" pasaremos al siguiente archivo
  if (length(pos_total) == 0) next
  
  #ahora haremos que cada archivo solo  vaya hasta la posicion donde se encuentra TOTAL
  lineas <- lineas[1:(pos_total)]
  
  #eliminaremos las líneas en blanco o vacías
  lineas <- lineas[lineas != ""]
  
  #como en todos los archivos las primeras lineas contienen la misma informacion,extraemos la   información
  empresa <- lineas[1]
  direccion <- lineas[2]
  ciudad <- lineas[3]
  
  #ajustaremos la forma en la que guarda los datos en la columna Telefono
  telefono_linea <- lineas[grep("TELÉFONO:", lineas)]
  telefono <- substring(telefono_linea, regexpr(":", telefono_linea) + 1)
  
  fecha <- lineas[5]
  
  #ajustaremos la forma en la que guarda los datos en la columna Factura
  factura_linea <- lineas[grep("FACTURA SIMPLIFICADA:", lineas)]
  factura <- substring(factura_linea, regexpr(":", factura_linea) + 2)
 
  descripcion <- lineas[7]
  
  #aqui indicamos que la variable cantidad va desde la linea 8 hasta la penultima de las       lineas que hemos leido de cada archivo, ya que no todos los tickets contienen la misma       cantidad de productos comprados
  rango <- 8:(length(lineas)-1)
  cantidad <- lineas[rango]
  
  #aqui indicamos que el total de la compra se encuentra en la ultima linea de cada archivo
  rango_total <- length(lineas)
  total <- lineas[rango_total]
  
  #almacenaremos la información en un data temporal
  data1_temporal <- data.frame(Empresa = empresa,
                            Direccion = direccion,
                            Ciudad = ciudad,
                            Telefono = telefono,
                            Fecha = fecha,
                            Factura = factura,
                            Cantidad = cantidad,
                            Total = total
                            )


  
  #añadiremos el data temporal a la lista de datos
  datos[[length(datos) + 1]] <- data1_temporal
}

# Uniremos todos los datas en uno solo
data1 <- bind_rows(datos)
#vamos a separar la columna Ciudad en dos , donde una se llamara codigo postal y otra ciudad
data1<- separate(data1, Ciudad, into = c("codigo postal", "ciudad"))
#aqui hemos hecho lo mismo pero con la columna Fecha la cual hemos separado en fecha y hora
data1 <- separate(data1, Fecha, into = c("fecha", "hora"), sep = "(\\s+|\\s+OP:\\s+)")

```

