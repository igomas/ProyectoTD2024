---
title: "ProyectoTD2024 Grupo F"
author: "Maria Castellanos, Pablo Pons, Irene Gómez, Jenny Carolina Matamoros, Andreu Herrero, Álvaro Cruz"
date: "2024-03-26"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Introduccion

El conjunto de datos que vamos a utilizar para el análisis de nuestro proyecto pertenecen al supermercado Mercadona. En concreto, son tickets de los usuarios que realizan sus compras en dicho supermercado, que tiene como propósito informar de las compras de dichos usuarios. 

En nuestro caso, hemos decidido hacer la exploración de las horas más concurridas, de la evolución del precio de los productos, del método de pago, del precio medio de la compra y de la media de la cantidad de los productos comprados.


# Preguntas

1. A qué hora se suele ir más a comprar?
2. Cuál ha sido el producto más comprado?
3. En que Mercadona se realizan más ventas?
4. Cual es el precio medio de los tickets?
5. En que mes se ha comprado más "x producto"?
6. ¿Cómo ha variado el precio promedio de los productos más vendidos en los últimos meses?


```{r, Warning = FALSE}
#Haremos la importacion de los datos
#descargaremos las librerias que necesitamos
#install.packages("pacman")
library(pacman)
p_load(readr, dplyr,tidyr,stringr)
#library(readr)
#library(dplyr)
#library(tidyr)
#
#Primero vamos a guardar en una variable la ruta donde se encuentra la carpeta con todos los ficheros que utilizaremos
carpeta_ruta <- ".\\data"

#Ahora declararemos una variable donde usaremos el codigo list.files para obtener una lista de archivos dentro de la carpeta de la cual solo vamos a seleccionar los archivos que sean .txt
archivos_texto <- list.files(path = carpeta_ruta , pattern = "\\.txt$", full.names = TRUE)

# Crearemos una lista donde almacenaremos los datos de cada archivo
datos <- list()

#iniciaremos un bucle, el cual iterara con todos los archivos en la lista de archivos
for (archivo in archivos_texto) {
  # Leeremos las líneas del archivo
  lineas <- read_lines(archivo, locale = locale(encoding = "latin1")) #ponemos el encoding correspondiente
  
  #Los datos que nos interesan del ticket son los que se encuentran hasta la linea donde nos   indica el precio total de la compra realizada, por lo que pondremos que busque la palabra    TOTAl, en la cual nos devolvera el numero donde se encuentra en cada archivo
  pos_total <- grep("TOTAL", lineas)
  
  # Si no se encuentra la palabra "TOTAL" pasaremos al siguiente archivo
  if (length(pos_total) == 0) next
  
  #ahora haremos que cada archivo solo  vaya hasta la posicion donde se encuentra TOTAL
  lineas <- lineas[1:(pos_total)]
  
  #eliminaremos las líneas en blanco o vacías
  lineas <- lineas[lineas != ""]
  
  #como en todos los archivos las primeras lineas contienen la misma informacion,extraemos la      información
  empresa <- lineas[1]
  direccion <- lineas[2]
  ciudad <- lineas[3]
  
  #ajustaremos la forma en la que guarda los datos en la columna Telefono
  telefono_linea <- lineas[grep("TELÉFONO:", lineas)]
  telefono <- substring(telefono_linea, regexpr(":", telefono_linea) + 1)
  
  fecha <- lineas[5]
  
  #ajustaremos la forma en la que guarda los datos en la columna Factura
  factura_linea <- lineas[grep("FACTURA SIMPLIFICADA:", lineas)]
  factura <- substring(factura_linea, regexpr(":", factura_linea) + 2)
 
  descripcion <- lineas[7]
  
  #aqui indicamos que la variable cantidad va desde la linea 8 hasta la penultima de las       lineas que hemos leido de cada archivo, ya que no todos los tickets contienen la misma       cantidad de productos comprados
  rango <- 8:(length(lineas)-1)
  cantidad <- lineas[rango]
  
  
  #aqui indicamos que el total de la compra se encuentra en la ultima linea de cada archivo
  rango_total <- length(lineas)
  total <- lineas[rango_total]
  
  #almacenaremos la información en un data temporal
  data1_temporal <- data.frame(Empresa = empresa,
                            Direccion = direccion,
                            Ciudad = ciudad,
                            Telefono = telefono,
                            Fecha = fecha,
                            Factura = factura,
                            Cantidad = cantidad,
                            Total = total
                            )


  
  #añadiremos el data temporal a la lista de datos
  datos[[length(datos) + 1]] <- data1_temporal
}

# Uniremos todos los datas en uno solo
data1 <- bind_rows(datos)
#vamos a separar la columna Ciudad en dos , donde una se llamara codigo postal y otra ciudad
data1<- separate(data1, Ciudad, into = c("codigo_postal", "ciudad"))
#aqui hemos hecho lo mismo pero con la columna Fecha la cual hemos separado en fecha y hora
data1 <- separate(data1, Fecha, into = c("fecha", "hora"), sep = "(\\s+|\\s+OP:\\s+)")
df <- as.data.frame(data1)

#Como nos podemos fijar en el data frame la variable de cantidad, no esta ajustada de una forma que nos facilite su importacion en el caso de un futuro analisis, por lo que deberemos ajustarla
#nos fijamos en que las lineas siguen un formato, estan las cantidades del producto y el producto unidas, por lo que usaremos la funcion gsub para que añada una "/" al principio para que cuando lea y vea que hay un numero seguido de una letra la añada
datos_cantidades <- gsub("(\\d+)([A-Z])", "\\1/\\2", data1$Cantidad)
#asignaremos la nueva forma a la variable del dataframe
data1$Cantidad <- datos_cantidades
#ahora nos fijamos en que no todas las lineas tiene un numero y una letra justo detras, sino que tiene un numero seguido de un espacio en blanco, haremos lo mismo 
datos_cantidades2 <- gsub("^([0-9]+) ", "\\1/ ", data1$Cantidad)
#asignaremos la nueva forma a la variable del dataframe
data1$Cantidad <- datos_cantidades2
#ahora podemos usar la funcion separate para poder separar la columna cantidad en dos, la cual una es cantidad y la otra producto, lo cual nos resultara mas facil ya que todos tienen un patron con /
data1 <- separate(data1, Cantidad, into = c("Cantidad", "Producto"), sep = "/", extra = "merge")

#ahora cambiaremos las comas por los puntos
producto1 <- gsub(",", ".", data1$Producto)
#asignaremos el nuevo formato 
data1$Producto <- producto1

#ahora nos encargaremos de separar la variable producto en producto y precio, ya que como se puede observar ambos estan unidos
producto_editado <- gsub(" ([0-9]+\\.[0-9]+)$", " /\\1", data1$Producto, perl = TRUE)
#lo asignaremos al dataframe
data1$Producto <- producto_editado

#usaremos la funcion de str_detect para hallar los indices de las filas donde se encuentra "kg" lo cual lo tomaremos como referencia para encontrar la fila que equivale al precio por kilo de las frutas que se encuentran en la columna "Cantidad"
indices2_kg <-  which(str_detect(data1$Cantidad, "kg"))
#guardaremos en una variable los valores que se encuentran en cada indice de la columna Cantidad
precios2_kg <- data1$Cantidad[indices2_kg]
#eliminar el final
precios2_kg <- gsub("\u0080", "", precios2_kg)
#Como se puede observar la fruta correspondiente al precio por kilo se encuentra en la fila anterior, por lo que haremos una variable con todos esos indices menos uno (anterior)
indice_anterior_kg <- indices2_kg - 1

#guardaremos todos los datos de las frutas en una variable 
producto_2 <- data1$Producto[indice_anterior_kg]
#procederemos a unir las variables de producto_2 y precio2_kg
producto_completo <- paste(producto_2, precios2_kg, sep = ", ")
#asignaremos a las filas de cada producto segun el indice en que localizamos donde estaban los nuevos productos completos
data1$Producto[indice_anterior_kg] <- producto_completo

#y como hemos conseguido que sigan un patron lo aprovecharemos para separarlo siguiendo dicha patron
data1 <- separate(data1, Producto, into = c("Producto", "Precio_Final"), sep = "/(?=[^/]+$)", extra = "merge")

#Visualizando el data frame, se han encontrado algunos errores, por ejemplo en las variables de Cantidad y Producto nos hemos encontrado con alguna fila con los datos de parking de entrada y salida, como en un principio se llego a la idea de no usarlo, mediante la funcion subset eliminaremos del dataframe tanto de la variable Producto como Cantidad todas aquellas filas donde aparezcan las palabras ENTRADA, SALIDA Y PARKING
data1 <- subset(data1, !grepl("ENTRADA|SALIDA|PARKING", data1$Cantidad, ignore.case = TRUE))
data1 <- subset(data1, !grepl("ENTRADA|SALIDA|PARKING", data1$Producto, ignore.case = TRUE))

# Bucle para reemplazar los NA con el valor de la siguiente fila
for (i in 1:(nrow(data1) - 1)) {
  if (is.na(data1$Precio_Final[i])) {
    data1$Precio_Final[i] <- data1$Precio_Final[i + 1]
  }
}

#Asignaremos la clase correspondiente a cada variable
data1$Precio_Final <- as.numeric(data1$Precio_Final)
data1$codigo_postal<- as.numeric(data1$codigo_postal)
data1$Telefono <- as.numeric(data1$Telefono)
data1$Cantidad <- as.numeric(data1$Cantidad)
data1$fecha <- as.Date(data1$fecha, format = "%d/%m/%Y")
data1 <- data1[complete.cases(data1$Cantidad), ]

#ahora arreglaremos los valores de la columna "Total" y lo convertiremos al tipo de variable que corresponde
datos_total <- data1$Total
datos_total<- gsub("[^0-9,]", "", datos_total)
data1$Total <-datos_total
#ahora cambiaremos las comas por los puntos
data1$Total <- gsub(",", ".", data1$Total)
data1$Total<- as.numeric(data1$Total)

```
```{r}
# Convertir los números en cadenas de texto
cantidades_texto <- as.character(data1$Cantidad)

# Filtrar los índices donde los números terminan en "100"
indices_pan <- which(grepl("100$", cantidades_texto))
pan <- data1$Cantidad[indices_pan]
sin_ultimos_tres <- as.numeric(substr(pan, 1, nchar(pan) - 3))
data1$Cantidad[indices_pan] <-sin_ultimos_tres


ultimos_tres_numeros <- substr(pan, nchar(pan) - 2, nchar(pan))
indices2_pan <- indices_pan
pan2 <- data1$Producto[indices2_pan]
producto1_completo <- paste(ultimos_tres_numeros, pan2, sep = " ")
#asignaremos a las filas de cada producto segun el indice en que localizamos donde estaban los nuevos productos completos
data1$Producto[indices2_pan] <- producto1_completo

# Convertir los números en cadenas de texto
cantidades_texto <- as.character(data1$Cantidad)

# Filtrar los índices donde los números terminan en "200"
indices_servilletas <- which(grepl("200$", cantidades_texto))


servilleta <- data1$Cantidad[indices_servilletas]

sin_ultimos_tres2 <- as.numeric(substr(servilleta, 1, nchar(servilleta) - 3))
data1$Cantidad[indices_servilletas] <-sin_ultimos_tres2


ultimos_tres_numeros2 <- substr(servilleta, nchar(servilleta) - 2, nchar(servilleta))
indices2_servilletas <- indices_servilletas
servilleta2 <- data1$Producto[indices2_servilletas]
producto2_completo <- paste(ultimos_tres_numeros2, servilleta2, sep = " ")
#asignaremos a las filas de cada producto segun el indice en que localizamos donde estaban los nuevos productos completos
data1$Producto[indices2_servilletas] <- producto2_completo



# Convertir los números en cadenas de texto
cantidades_texto <- as.character(data1$Cantidad)

# Filtrar los índices donde los números terminan en "12"
indices_huevos <- which(grepl("12$", cantidades_texto))
huevos <- data1$Cantidad[indices_huevos]

sin_ultimos_dos <- as.numeric(substr(huevos, 1, nchar(huevos) - 2))
data1$Cantidad[indices_huevos] <-sin_ultimos_dos


ultimos_dos_numeros <- substr(huevos, nchar(huevos) - 1, nchar(huevos))
indices2_huevos <- indices_huevos
huevos2 <- data1$Producto[indices2_huevos]
producto3_completo <- paste(ultimos_dos_numeros, huevos2, sep = " ")
#asignaremos a las filas de cada producto segun el indice en que localizamos donde estaban los nuevos productos completos
data1$Producto[indices2_huevos] <- producto3_completo


cantidades_texto <- as.character(data1$Cantidad)
indices_cierrafacil <- which(grepl("140$", cantidades_texto))
cierrafacil <- data1$Cantidad[indices_cierrafacil]

indices2_cierrafacil <- indices_cierrafacil
cierrafacil2 <- data1$Producto[indices2_cierrafacil]
producto4_completo <- paste(cierrafacil, cierrafacil2, sep = " ")
data1$Producto[indices2_cierrafacil] <- producto4_completo


data1$Cantidad <- gsub("140$", "1", data1$Cantidad)
data1$Cantidad <- as.numeric(data1$Cantidad)
```





